!function(e){var n={};function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(r,o,function(n){return e[n]}.bind(null,o));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=13)}([function(e,n){e.exports=require("path")},function(e,n,t){"use strict";t.d(n,"a",(function(){return r}));var r="../ServerStorage"},function(e,n){e.exports=require("fs")},function(e,n){e.exports=require("xlsx")},function(e,n,t){"use strict";t.d(n,"a",(function(){return i}));var r=t(2);function o(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=function(){function e(n,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.filePath=n,this.fileSize=t||0}var n,t,i;return n=e,(t=[{key:"writeChunk",value:function(e,n,t){var o=this;return console.log("writeChunk",e,n),r.promises.open(this.filePath,"a",493).then((function(r){return r.write(n).then((function(n){var r=n.bytesWritten,i=(e+=r)/o.fileSize,c=e===o.fileSize?"LAST":"MOST";return t({position:e,part:c,percent:i})})).catch((function(e){return console.error("Write@WriteChunk: ".concat(e))})).finally((function(){r.close()}))})).catch((function(e){return console.error("Open@WriteChunk: ".concat(e))}))}},{key:"readChunk",value:function(e,n,t){var o=this;return void 0===this.buffer&&(this.buffer=Buffer.allocUnsafe(524288)),r.promises.stat(this.filePath).then((function(e){var n=e.size;return o.fileSize=n,r.promises.open(o.filePath,"r",493)})).then((function(t){return t.read(o.buffer,0,524288,e).then((function(t){var r=t.bytesRead,i=t.buffer,c=e+r;i=i.slice(0,r);var a=c/o.fileSize,u={part:c===o.fileSize?"LAST":"MOST",nextPos:c,percent:a,buffer:i};return console.log(u),n(u)})).catch((function(e){return console.error("Read@ReadChunk: ".concat(e))})).finally((function(){t.close()}))})).catch((function(e){console.log(e),t?t(e):console.error("Open@ReadChunk: ".concat(e))}))}},{key:"writeFile",value:function(e,n){var t=this;return r.promises.open(this.filePath,"w",493).then((function(r){return r.writeFile(e).then((function(e){r.close().then((function(){void 0!==n&&n(t)})).catch((function(e){console.error("close on writeFile: ",e)}))}))}))}}])&&o(n.prototype,t),i&&o(n,i),e}()},function(e,n){e.exports=require("del")},function(e,n,t){"use strict";var r=t(3),o=t.n(r),i=t(0),c=t.n(i),a=t(5),u=t.n(a),l={BALANCE:[["会计年","iyear"],["会计月","iperiod"],["科目编号","ccode"],["科目编码","ccode"],["科目名称","ccode_name"],["科目类别","cclass"],["账面期初数","mb"],["账面期初余额","mb"],["期初余额","mb"],["期初金额","mb"],["期初余额借方","mbd"],["期初余额贷方","mbc"],["本期发生借方","md"],["账面借方发生额","md"],["未审借方发生额","md"],["借方发生额","md"],["账面贷方发生额","mc"],["贷方发生额","mc"],["未审贷方发生额","mc"],["本期发生贷方","mc"],["账面期末数","me"],["账面期末余额","me"],["期末金额","me"],["期末余额","me"],["期末余额借方","med"],["期末余额贷方","mec"]],JOURNAL:[["会计年","iyear"],["会计月","iperiod"],["记账时间","dbill_date"],["凭证编号","ino_id"],["编号","inid"],["行","inid"],["业务说明","cdigest"],["摘要","cdigest"],["科目编号","ccode"],["科目编码","ccode"],["科目名称","ccode_name"],["借方发生额","md"],["贷方发生额","mc"],["对方科目名称","ccode_equal"]],ASSISTED:[["科目名称","ccode_name"],["科目编号","ccode"],["科目编码","ccode"],["会计月","iperiod"],["凭证编号","ino_id"],["编号","inid"],["业务说明","cdigest"],["核算项目类型编号","check_type_code"],["核算项目类型名称","check_type_name"],["核算项目ID","check_id"],["核算项目名称","check_name"],["核算项目序号","check_num"],["借方发生额","mb"],["贷方发生额","mc"],["会计年","iyear"],["对方科目名称","ccode_equal"],["记账时间","dbill_date"]],CASHFLOW_WORKSHEET:[["项目","item"],["值","value"],["item","item"],["value","value"]],FINANCIAL_WORKSHEET:[["项目","item"],["值","value"]]};function s(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function f(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=[],r=!0,o=!1,i=void 0;try{for(var c,a=e[Symbol.iterator]();!(r=(c=a.next()).done)&&(t.push(c.value),!n||t.length!==n);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}return t}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}t.d(n,"a",(function(){return p}));var d=t(2).promises,m="../ServerStorage";function v(e,n){for(var t=l[e],r=n.Sheets[n.SheetNames[0]],i=o.a.utils.sheet_to_json(r),c=0;c<i.length;c++){for(var a=i[c],u={},s=0;s<t.length;s++){var d=f(t[s],2),m=d[0],v=d[1];m in a&&(u[v]=a[m])}void 0===u.iperiod&&(u.iperiod=0),i[c]=u}return console.log("parseRemap",i),i}function p(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return e};return console.log("restoring",c.a.resolve(m,e,n)),u()([c.a.resolve(m,e,n,"RESTORED.*")],{force:!0}).then((function(){return d.readdir(c.a.resolve(m,e,n))})).then((function(r){var i=r.filter((function(e){return e.includes("SOURCE")}));console.log("ready to handle",r,i);var a={BALANCE:[],JOURNAL:[],ASSISTED:[],CASHFLOW_WORKSHEET:[],FINANCIAL_WORKSHEET:[]};return Promise.all(i.map((function(t){return d.readFile(c.a.resolve(m,e,n,t)).then((function(e){return o.a.read(e,{type:"buffer"})})).catch((function(e){console.error(e,"err in reading.")}))}))).then((function(r){for(var o=0;o<i.length;o++){var u,l=i[o],p=r[o],h=f(l.split("."),3),y=(h[0],h[1]),E=(h[2],v(y,p));if("BALANCE"===y){var g=E[0],S=g.mbc,O=g.mbd,b=g.mb;if(void 0!==S&&void 0!==O&&void 0===b){var N=!0,R=!1,_=void 0;try{for(var T,A=E[Symbol.iterator]();!(N=(T=A.next()).done);N=!0){var j=T.value;j.mb=0===j.mbc?j.mbd:j.mbc}}catch(e){R=!0,_=e}finally{try{N||null==A.return||A.return()}finally{if(R)throw _}}}var w=E[0],C=w.mec,P=w.med,x=w.me;if(void 0!==C&&void 0!==P&&void 0===x){var k=!0,D=!1,L=void 0;try{for(var I,F=E[Symbol.iterator]();!(k=(I=F.next()).done);k=!0){var W=I.value;W.me=0===W.mec?W.med:W.mec}}catch(e){D=!0,L=e}finally{try{k||null==F.return||F.return()}finally{if(D)throw L}}}E=E.filter((function(e){return!e.ccode_name.trim().startsWith("*")}))}if(["CASHFLOW_WORKSHEET","FINANCIAL_WORKSHEET"].includes(y))a[y]=E;else(u=a[y]).push.apply(u,s(E))}return a=t(a),console.log(Object.values(a).map((function(e){return e.length})),"restoring"),Promise.all(Object.keys(a).map((function(t){return 0===a[t].length||d.writeFile(c.a.resolve(m,e,n,"RESTORED.".concat(t,".JSON")),JSON.stringify(a[t]))})))}))}))}},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("cors")},function(e,n){e.exports=require("recursive-copy")},function(e,n,t){"use strict";var r=t(5),o=t.n(r),i=t(0),c=t.n(i),a=t(1);function u(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=[],r=!0,o=!1,i=void 0;try{for(var c,a=e[Symbol.iterator]();!(r=(c=a.next()).done)&&(t.push(c.value),!n||t.length!==n);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}return t}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var l=t(2).promises;function s(e,n,t){var r=e,o=c.a.join(a.a,"public",r),i="SOURCE.".concat(r);return{sourcePath:o,targetPath:c.a.join(a.a,n,t,i)}}n.a=function(e){return e.on("REQUIRE_PROJECT_LIST",function(e){return function(n){var t=n.id;console.log("Received requiring list of projects from ",t),l.readdir(c.a.resolve(a.a,t),{withFileTypes:!0}).then((function(n){var t=n.filter((function(e){return e.isDirectory()})).map((function(e){var n=u(e.name.split("-"),2);return{projName:n[0],year:n[1]}}));e.emit("PROJECT_LIST",{list:t})})).catch((function(e){console.log("server reading local file failed",e)}))}}(e)),e.on("CREATE_PROJECT",function(e){return function(n){var t=n.id,r=n.projName,o=n.year;console.log("Creating directory of ",r);var i="".concat(r,"-").concat(o),u=c.a.join(a.a,t,i);l.mkdir(u).then((function(){var e=s("CASHFLOW_WORKSHEET.xlsx",t,i),n=e.sourcePath,r=e.targetPath;return l.copyFile(n,r)})).then((function(){var e=s("FINANCIAL_WORKSHEET.xlsx",t,i),n=e.sourcePath,r=e.targetPath;return l.copyFile(n,r)})).then((function(){console.log("create directory done"),e.emit("CREATE_PROJECT_DONE",{})})).catch((function(n){var t=n.code;e.emit("ERROR",{msg:t})}))}}(e)),e.on("DELETE_PROJECT",function(e){return function(n){var t=n.id,r=n.projName;console.log("received DELETE",r,c.a.join(a.a,t,r));var i=c.a.join(a.a,t,r);o()([i],{force:!0}).then((function(){console.log("remove directory done"),e.emit("DELETE_PROJECT_DONE",{})})).catch((function(n){console.log(n),e.emit("ERROR",{msg:n.code})}))}}(e)),e}},function(e,n,t){"use strict";var r=t(0),o=t.n(r),i=t(4),c=t(6),a=t(1),u=t(2).promises;n.a=function(e,n){return e.on("PREPARE_TO_RECEIVE",function(e,n){return function(t){var r=t.id,c=t.projName,l=t.name,s=t.size;console.log("prep to receive",r,c,l,s);var f=o.a.resolve(a.a,r,c,l);u.access(f).then((function(){return console.log("File with same name has been removed."),u.unlink(f)})).catch((function(e){console.log(e)})).finally((function(){console.log(f,s,"finally"),n["".concat(r,"-").concat(c,"-").concat(l)]=new i.a(f,s),e.emit("SEND",{name:l,percent:0,position:0})}))}}(e,n)),e.on("RECEIVE",function(e,n){return function(t){var r=t.id,o=t.position,i=t.projName,c=t.name,a=t.data;console.log("receiving",r,c);n["".concat(r,"-").concat(i,"-").concat(c)].writeChunk(o,a,(function(n){var t=n.part,r=n.percent,o=n.position;console.log("afterWrite",t,r,o);var i={LAST:"RECEIVE_DONE",MOST:"SEND"}[t];e.emit(i,{name:c,percent:r,position:o})}))}}(e,n)),e.on("RESTORE",function(e){return function(n){var t=n.id,r=n.projName;Object(c.a)(t,r).then((function(n){e.emit("RESTORE_DONE",{})})).catch((function(e){console.log("error during restoring xls files",e)}))}}(e)),e}},function(e,n,t){"use strict";t.r(n),function(e){var n=t(7),r=t.n(n),o=t(0),i=t.n(o),c=t(8),a=t.n(c),u=t(9),l=t.n(u),s=t(10),f=t.n(s),d=t(1),m=t(4),v=t(3),p=t.n(v),h=(t(6),t(11)),y=t(12);function E(e){return(E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var g=t(2).promises,S=new(t(14))({filename:i.a.resolve(e,"../passwords"),autoload:!0});S.ensureIndex({fieldName:"username",unique:!0});var O={},b=r()(),N=b.listen(8080,(function(){console.log("Server is listening 8080, for HTTPS"),console.log("run from the "+e)})),R=t(15).listen(N),_=R.of("/TABLES"),T=R.of("/UPLOAD"),A=R.of("/PROJECT"),j=R.of("/AUTH");function w(e,n){return"RESTORED.".concat(e).concat(void 0===n?"":"."+n,".JSON")}b.use(r.a.static(i.a.join(e,"../public"))),b.use(a.a.urlencoded({extended:!1})),b.use(a.a.json()),b.use(l()()),b.get("*",(function(e,n){n.redirect("/")})),A.on("connection",(function(e){e=Object(h.a)(e)})),T.on("connection",(function(e){e=Object(y.a)(e,O)})),_.on("connection",(function(e){e.on("SEND",(function(n){var t=n.id,r=n.projName,o=n.sheetName,c=n.type,a=n.position;console.log("SENDING ".concat(r,"-").concat(o).concat(c?"-".concat(c):""," FROM@ ").concat(a));var u=w(o,c);console.log("restored filename",u);var l="".concat(t,"-").concat(u,"-").concat(r);void 0===O[l]&&(O[l]=new m.a(i.a.resolve(d.a,t,r,u))),O[l].readChunk(a,(function(n){var t=n.part,i=n.percent,c=n.nextPos,a=n.buffer,u={LAST:"DONE",MOST:"RECV"}[t];console.log("SENDING ".concat(r,"-").concat(o," ENDS@ ").concat(c," ").concat(t," ").concat(u)),e.emit(u,{projName:r,sheetName:o,percent:i,position:c,data:a})}),(function(n){"ENOENT"===n.code&&("CONF"===c?(console.log("CONF not created yet."),e.emit("DONE",{projName:r,sheetName:o,data:Buffer.from("[]")})):e.emit("NOTFOUND",{sheetName:o,projName:r}))}))})),e.on("SAVE",(function(e){var n,t=e.id,r=e.projName,o=e.sheetName,c=e.type,a=e.data;switch(E(a)){case"string":console.log("received data as string"),n=Buffer.from(a);break;case"object":console.log("received data as object, whoa"),n=Buffer.from(JSON.stringify(a))}console.log(d.a,t,r,u);var u=w("saved".concat(o),c),l=i.a.resolve(d.a,t,r,u);g.writeFile(l,n)})),e.on("EXPORT",(function(n){n.id;var t=n.projName,r=n.sheetName,o=n.data,i=p.a.utils.book_new();if(Array.isArray(o)){var c=p.a.utils.json_to_sheet(o);i.SheetNames.push("sheet1"),i.Sheets.sheet1=c}else for(var a in console.log(o),o){var u=p.a.utils.json_to_sheet(o[a]);i.SheetNames.push(a),i.Sheets[a]=u}var l=function(e){for(var n=new ArrayBuffer(e.length),t=new Uint8Array(n),r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return n}(p.a.write(i,{bookType:"xlsx",type:"binary"}));e.emit("EXPORTED",{outputArrayBuffed:l,projName:t,sheetName:r})}))})),j.on("connection",(function(e){e.on("LOGIN",(function(n){var t=n.username,r=n.password;console.log(t,r,"recved"),S.findOne({username:t,password:r},(function(n,t){if(null!==t){console.log(t,"account found");var r=t.username,o=t.nickname,i=t._id;e.emit("LOG_DONE",{username:r,nickname:o,id:i})}else e.emit("LOG_NOT_FOUND")}))})),e.on("REGISTER",(function(n){var t=n.username,r=n.password,o=n.nickname;S.insert({username:t,password:r,nickname:o},(function(n,t){if(n)"uniqueViolated"===n.errorType?e.emit("REG_DUP_NAME"):e.emit("ERROR",JSON.stringify(n));else{console.log(t,"reged");var r=t._id;g.mkdir(i.a.resolve(d.a,r)).then((function(){return f()(i.a.resolve(d.a,"public","示例项目-2018"),i.a.resolve(d.a,r,"示例项目-2018")).catch((function(e){console.log("file copying",e)}))})).then((function(){e.emit("REG_DONE",{id:t._id})})).catch((function(n){e.emit("ERROR",JSON.stringify(n))}))}}))}))}))}.call(this,"server-src")},function(e,n){e.exports=require("nedb")},function(e,n){e.exports=require("socket.io")}]);