!function(e){var n={};function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(r,o,function(n){return e[n]}.bind(null,o));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=12)}([function(e,n){e.exports=require("path")},function(e,n,t){"use strict";t.d(n,"a",(function(){return r}));var r="../ServerStorage"},function(e,n){e.exports=require("fs")},function(e,n){e.exports=require("xlsx")},function(e,n,t){"use strict";t.d(n,"a",(function(){return i}));var r=t(2);function o(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var i=function(){function e(n,t){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.filePath=n,this.fileSize=t||0}var n,t,i;return n=e,(t=[{key:"writeChunk",value:function(e,n,t){var o=this;return console.log("writeChunk",e,n),r.promises.open(this.filePath,"a",493).then((function(r){return r.write(n).then((function(n){var r=n.bytesWritten,i=(e+=r)/o.fileSize,c=e===o.fileSize?"LAST":"MOST";return t({position:e,part:c,percent:i})})).catch((function(e){return console.error("Write@WriteChunk: ".concat(e))})).finally((function(){r.close()}))})).catch((function(e){return console.error("Open@WriteChunk: ".concat(e))}))}},{key:"readChunk",value:function(e,n,t){var o=this;return void 0===this.buffer&&(this.buffer=Buffer.allocUnsafe(524288)),r.promises.stat(this.filePath).then((function(e){var n=e.size;return o.fileSize=n,r.promises.open(o.filePath,"r",493)})).then((function(t){return t.read(o.buffer,0,524288,e).then((function(t){var r=t.bytesRead,i=t.buffer,c=e+r;i=i.slice(0,r);var a=c/o.fileSize,u={part:c===o.fileSize?"LAST":"MOST",nextPos:c,percent:a,buffer:i};return console.log(u),n(u)})).catch((function(e){return console.error("Read@ReadChunk: ".concat(e))})).finally((function(){t.close()}))})).catch((function(e){t?t(e):console.error("Open@ReadChunk: ".concat(e))}))}},{key:"writeFile",value:function(e,n){var t=this;return r.promises.open(this.filePath,"w",493).then((function(r){return r.writeFile(e).then((function(e){r.close().then((function(){void 0!==n&&n(t)})).catch((function(e){console.error("close on writeFile: ",e)}))}))}))}}])&&o(n.prototype,t),i&&o(n,i),e}()},function(e,n){e.exports=require("del")},function(e,n,t){"use strict";var r=t(3),o=t.n(r),i=t(0),c=t.n(i),a=t(5),u=t.n(a),s={BALANCE:[["会计年","iyear"],["会计月","iperiod"],["科目编号","ccode"],["科目名称","ccode_name"],["科目类别","cclass"],["账面期初数","mb"],["期初金额","mb"],["期初余额","mb"],["账面借方发生额","md"],["借方发生额","md"],["账面贷方发生额","mc"],["贷方发生额","mc"],["账面期末数","me"],["期末金额","me"],["期末余额","me"]],JOURNAL:[["会计年","iyear"],["会计月","iperiod"],["记账时间","dbill_date"],["凭证编号","ino_id"],["编号","inid"],["行","inid"],["业务说明","cdigest"],["摘要","cdigest"],["科目编号","ccode"],["科目名称","ccode_name"],["借方发生额","md"],["贷方发生额","mc"],["对方科目名称","ccode_equal"]],ASSISTED:[["科目名称","ccode_name"],["科目编号","ccode"],["会计月","iperiod"],["凭证编号","ino_id"],["编号","inid"],["业务说明","cdigest"],["核算项目类型编号","check_type_code"],["核算项目类型名称","check_type_name"],["核算项目ID","check_id"],["核算项目名称","check_name"],["核算项目序号","check_num"],["借方发生额","mb"],["贷方发生额","mc"],["会计年","iyear"],["对方科目名称","ccode_equal"],["记账时间","dbill_date"]],CASHFLOW_WORKSHEET:[["项目","item"],["值","value"]],FINANCIAL_WORKSHEET:[["项目","item"],["值","value"]]};function l(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function f(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=[],r=!0,o=!1,i=void 0;try{for(var c,a=e[Symbol.iterator]();!(r=(c=a.next()).done)&&(t.push(c.value),!n||t.length!==n);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}return t}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}t.d(n,"a",(function(){return h}));var d=t(2).promises,m="../ServerStorage";function p(e,n){var t=s[e],r=n.Sheets[n.SheetNames[0]],i=o.a.utils.sheet_to_json(r);console.log(i);for(var c=0;c<i.length;c++){for(var a=i[c],u={},l=0;l<t.length;l++){var d=f(t[l],2),m=d[0],p=d[1];m in a&&(u[p]=a[m])}void 0===u.iperiod&&(u.iperiod=0),i[c]=u}return i}function h(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return e};return console.log("restoring",c.a.resolve(m,e,n)),u()([c.a.resolve(m,e,n,"RESTORED.*")],{force:!0}).then((function(){return d.readdir(c.a.resolve(m,e,n))})).then((function(r){var i=r.filter((function(e){return e.includes("SOURCE")}));console.log("ready to handle",r,i);var a={BALANCE:[],JOURNAL:[],ASSISTED:[],CASHFLOW_WORKSHEET:[],FINANCIAL_WORKSHEET:[]};return Promise.all(i.map((function(t){return d.readFile(c.a.resolve(m,e,n,t)).then((function(e){return o.a.read(e,{type:"buffer"})})).catch((function(e){console.error(e,"err in reading.")}))}))).then((function(r){for(var o=0;o<i.length;o++){var u,s=i[o],h=r[o],v=f(s.split("."),3),E=(v[0],v[1]),y=(v[2],p(E,h));if(["CASHFLOW_WORKSHEET","FINANCIAL_WORKSHEET"].includes(E))a[E]=y;else(u=a[E]).push.apply(u,l(y))}return a=t(a),console.log(Object.values(a).map((function(e){return e.length})),"restoring"),Promise.all(Object.keys(a).map((function(t){return 0===a[t].length||d.writeFile(c.a.resolve(m,e,n,"RESTORED.".concat(t,".JSON")),JSON.stringify(a[t]))})))}))}))}},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("cors")},function(e,n,t){"use strict";var r=t(5),o=t.n(r),i=t(0),c=t.n(i),a=t(1);function u(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=[],r=!0,o=!1,i=void 0;try{for(var c,a=e[Symbol.iterator]();!(r=(c=a.next()).done)&&(t.push(c.value),!n||t.length!==n);r=!0);}catch(e){o=!0,i=e}finally{try{r||null==a.return||a.return()}finally{if(o)throw i}}return t}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var s=t(2).promises;function l(e,n,t){var r=e,o=c.a.join(a.a,"public",r),i="SOURCE.".concat(r);return{sourcePath:o,targetPath:c.a.join(a.a,n,t,i)}}n.a=function(e){return e.on("REQUIRE_PROJECT_LIST",function(e){return function(n){var t=n.id;console.log("Received requiring list of projects from ",t),s.readdir(c.a.resolve(a.a,t),{withFileTypes:!0}).then((function(n){var t=n.filter((function(e){return e.isDirectory()})).map((function(e){var n=u(e.name.split("-"),2);return{projName:n[0],year:n[1]}}));e.emit("PROJECT_LIST",{list:t})})).catch((function(e){console.log("server reading local file failed",e)}))}}(e)),e.on("CREATE_PROJECT",function(e){return function(n){var t=n.id,r=n.projName,o=n.year;console.log("Creating directory of ",r);var i="".concat(r,"-").concat(o),u=c.a.join(a.a,t,i);s.mkdir(u).then((function(){var e=l("CASHFLOW_WORKSHEET.xlsx",t,i),n=e.sourcePath,r=e.targetPath;return s.copyFile(n,r)})).then((function(){var e=l("FINANCIAL_WORKSHEET.xlsx",t,i),n=e.sourcePath,r=e.targetPath;return s.copyFile(n,r)})).then((function(){console.log("create directory done"),e.emit("CREATE_PROJECT_DONE",{})})).catch((function(n){var t=n.code;e.emit("ERROR",{msg:t})}))}}(e)),e.on("DELETE_PROJECT",function(e){return function(n){var t=n.id,r=n.projName;console.log("received DELETE",r,c.a.join(a.a,t,r));var i=c.a.join(a.a,t,r);o()([i],{force:!0}).then((function(){console.log("remove directory done"),e.emit("DELETE_PROJECT_DONE",{})})).catch((function(n){console.log(n),e.emit("ERROR",{msg:n.code})}))}}(e)),e}},function(e,n,t){"use strict";var r=t(0),o=t.n(r),i=t(4),c=t(6),a=t(1),u=t(2).promises;n.a=function(e,n){return e.on("PREPARE_TO_RECEIVE",function(e,n){return function(t){var r=t.id,c=t.projName,s=t.name,l=t.size;console.log("prep to receive",r,c,s,l);var f=o.a.resolve(a.a,r,c,s);u.access(f).then((function(){return console.log("File with same name has been removed."),u.unlink(f)})).catch((function(e){console.log(e)})).finally((function(){console.log(f,l,"finally"),n["".concat(r,"-").concat(c,"-").concat(s)]=new i.a(f,l),e.emit("SEND",{name:s,percent:0,position:0})}))}}(e,n)),e.on("RECEIVE",function(e,n){return function(t){var r=t.id,o=t.position,i=t.projName,c=t.name,a=t.data;console.log("receiving",r,c);n["".concat(r,"-").concat(i,"-").concat(c)].writeChunk(o,a,(function(n){var t=n.part,r=n.percent,o=n.position;console.log("afterWrite",t,r,o);var i={LAST:"RECEIVE_DONE",MOST:"SEND"}[t];e.emit(i,{name:c,percent:r,position:o})}))}}(e,n)),e.on("RESTORE",function(e){return function(n){var t=n.id,r=n.projName;Object(c.a)(t,r).then((function(n){e.emit("RESTORE_DONE",{})})).catch((function(e){console.log("error during restoring xls files",e)}))}}(e)),e}},function(e,n,t){"use strict";t.r(n),function(e){var n=t(7),r=t.n(n),o=t(0),i=t.n(o),c=t(8),a=t.n(c),u=t(9),s=t.n(u),l=t(1),f=t(4),d=t(3),m=t.n(d),p=(t(6),t(10)),h=t(11);function v(e){return(v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var E=t(2).promises,y=new(t(13))({filename:i.a.resolve(e,"../passwords"),autoload:!0});y.ensureIndex({fieldName:"username",unique:!0});var g={},O=r()(),S=O.listen(8080,(function(){console.log("Server is listening 8080, for HTTPS"),console.log("run from the "+e)})),N=t(14).listen(S),b=N.of("/TABLES"),R=N.of("/UPLOAD"),_=N.of("/PROJECT"),T=N.of("/AUTH");function A(e,n){return"RESTORED.".concat(e).concat(void 0===n?"":"."+n,".JSON")}O.use(r.a.static(i.a.join(e,"../public"))),O.use(a.a.urlencoded({extended:!1})),O.use(a.a.json()),O.use(s()()),O.get("*",(function(e,n){n.redirect("/")})),_.on("connection",(function(e){e=Object(p.a)(e)})),R.on("connection",(function(e){e=Object(h.a)(e,g)})),b.on("connection",(function(e){e.on("SEND",(function(n){var t=n.id,r=n.projName,o=n.sheetName,c=n.type,a=n.position;console.log("SENDING ".concat(r,"-").concat(o).concat(c?"-".concat(c):""," FROM@ ").concat(a));var u=A(o,c);console.log("restored filename",u);var s="".concat(t,"-").concat(u);void 0===g[s]&&(g[s]=new f.a(i.a.resolve(l.a,t,r,u))),g[s].readChunk(a,(function(n){var t=n.part,i=n.percent,c=n.nextPos,a=n.buffer,u={LAST:"DONE",MOST:"RECV"}[t];console.log("SENDING ".concat(r,"-").concat(o," ENDS@ ").concat(c," ").concat(t," ").concat(u)),e.emit(u,{projName:r,sheetName:o,percent:i,position:c,data:a})}),(function(n){"ENOENT"===n.code&&("CONF"===c?(console.log("CONF not created yet."),e.emit("DONE",{projName:r,sheetName:o,data:Buffer.from("[]")})):e.emit("NOTFOUND",{sheetName:o,projName:r}))}))})),e.on("SAVE",(function(e){var n,t=e.id,r=e.projName,o=e.sheetName,c=e.type,a=e.data;switch(v(a)){case"string":console.log("received data as string"),n=Buffer.from(a);break;case"object":console.log("received data as object, whoa"),n=Buffer.from(JSON.stringify(a))}console.log(l.a,t,r,u);var u=A("saved".concat(o),c),s=i.a.resolve(l.a,t,r,u);E.writeFile(s,n)})),e.on("EXPORT",(function(n){n.id;var t=n.projName,r=n.sheetName,o=n.data,i=m.a.utils.book_new();if(Array.isArray(o)){var c=m.a.utils.json_to_sheet(o);i.SheetNames.push("sheet1"),i.Sheets.sheet1=c}else for(var a in console.log(o),o){var u=m.a.utils.json_to_sheet(o[a]);i.SheetNames.push(a),i.Sheets[a]=u}var s=function(e){for(var n=new ArrayBuffer(e.length),t=new Uint8Array(n),r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return n}(m.a.write(i,{bookType:"xlsx",type:"binary"}));e.emit("EXPORTED",{outputArrayBuffed:s,projName:t,sheetName:r})}))})),T.on("connection",(function(e){e.on("LOGIN",(function(n){var t=n.username,r=n.password;console.log(t,r,"recved"),y.findOne({username:t,password:r},(function(n,t){if(null!==t){console.log(t,"account found");var r=t.username,o=t.nickname,i=t._id;e.emit("LOG_DONE",{username:r,nickname:o,id:i})}else e.emit("LOG_NOT_FOUND")}))})),e.on("REGISTER",(function(n){var t=n.username,r=n.password,o=n.nickname;y.insert({username:t,password:r,nickname:o},(function(n,t){if(n)"uniqueViolated"===n.errorType?e.emit("REG_DUP_NAME"):e.emit("ERROR",JSON.stringify(n));else{console.log(t,"reged");var r=t._id;E.mkdir(i.a.resolve(l.a,r)).then((function(){e.emit("REG_DONE",{id:t._id})})).catch((function(n){e.emit("ERROR",JSON.stringify(n))}))}}))}))}))}.call(this,"server-src")},function(e,n){e.exports=require("nedb")},function(e,n){e.exports=require("socket.io")}]);